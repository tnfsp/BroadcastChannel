---
import '../assets/normalize.css'
import '../assets/style.css'
import '../assets/global.css'
import { SEO } from 'astro-seo'
import { getEnv } from '../lib/env'
import backToTopIcon from '../assets/back-to-top.svg'

const { SITE_URL, RSS_URL, RSS_PREFIX } = Astro.locals
const { channel } = Astro.props

const locale = getEnv(import.meta.env, Astro, 'LOCALE')

const seo = channel?.seo
const reqPathname = Astro.url.pathname.replace(/\/$/, '')
const canonical = SITE_URL.startsWith('http') ? new URL(SITE_URL).origin + reqPathname : Astro.url.origin + reqPathname

const { origin } = new URL(canonical)
const twitter = getEnv(import.meta.env, Astro, 'TWITTER')

const seoParams = {
  title: seo?.title,
  description: seo?.text ?? channel?.description,
  canonical,
  noindex: seo?.noindex ?? getEnv(import.meta.env, Astro, 'NOINDEX'),
  nofollow: seo?.nofollow ?? getEnv(import.meta.env, Astro, 'NOFOLLOW'),
  openGraph: {
    basic: {
      type: 'website',
      title: channel?.title ?? '',
      url: canonical,
      image: channel?.avatar ? channel.avatar : origin + '/favicon.ico',
    },
    optional: {
      description: seo?.text ?? channel?.description,
      locale,
    },
  },
  extend: {
    link: [
      {
        rel: 'icon',
        href: channel?.avatar
          ? `https://wsrv.nl/?w=64&h=64&fit=cover&mask=circle&url=ssl:${channel?.avatar?.replace(/^https?:\/\//, '')}`
          : '/favicon.svg',
      },
    ],
  },
}

const GOOGLE_SEARCH_SITE = getEnv(import.meta.env, Astro, 'GOOGLE_SEARCH_SITE')
const searchAction = GOOGLE_SEARCH_SITE ? 'https://www.google.com/search' : '/search/result'

const HEADER_INJECT = getEnv(import.meta.env, Astro, 'HEADER_INJECT')
const FOOTER_INJECT = getEnv(import.meta.env, Astro, 'FOOTER_INJECT')
const staticProxy = getEnv(import.meta.env, Astro, 'STATIC_PROXY') ?? '/static/'
const navAvatar = channel?.avatar?.startsWith('http') ? staticProxy + channel.avatar : '/favicon.svg'
const navs = [
  { title: 'Home', href: 'https://wilsonchao.com' },
  { title: 'Blog', href: 'https://wilsonchao.com/blog' },
  { title: 'Murmur', href: 'https://murmur.wilsonchao.com' },
  { title: 'Daily', href: 'https://wilsonchao.com/daily' },
  { title: 'About', href: 'https://wilsonchao.com/about' },
  { title: 'Links', href: 'https://wilsonchao.com/links' },
]
---

<!doctype html>
<html lang={locale ?? 'en'}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f4f1ec" />
    <link rel="alternate" type="application/rss+xml" title={`${RSS_PREFIX}${channel?.title}`} href={RSS_URL} />
    <style is:inline>
      @view-transition {
        navigation: auto; /* enabled */
      }
    </style>
    <SEO
      titleTemplate={`%s | ${channel?.title}`}
      titleDefault={[channel?.title, seoParams.description].filter(Boolean).join(' - ')}
      twitter={{
        card: 'summary_large_image',
        creator: twitter ? `@${twitter}` : undefined,
      }}
      {...seoParams}
    />
    <Fragment set:html={HEADER_INJECT} />
  </head>

  <body>
    <header class="site-nav-bar">
      <div class="site-nav-inner">
        <a href={SITE_URL} aria-label="Go to homepage" class="site-nav-brand">
          <img src={navAvatar} alt={channel?.title} loading="eager" />
        </a>
        <nav class="site-nav" aria-label="Primary navigation">
          {
            navs.map((nav) => (
              <a href={nav.href} title={nav.title} class="site-nav-link">
                {nav.title}
              </a>
            ))
          }
        </nav>
        <button
          type="button"
          class="nav-toggle"
          aria-expanded="false"
          aria-controls="mobile-nav"
          data-nav-toggle
        >
          Menu
          <span class="nav-toggle-icon" aria-hidden="true">></span>
        </button>
      </div>
      <div class="mobile-nav" id="mobile-nav" data-mobile-nav hidden>
        <div class="mobile-nav-panel">
          {
            navs.map((nav) => (
              <a href={nav.href} title={nav.title} class="mobile-nav-link">
                {nav.title}
              </a>
            ))
          }
        </div>
      </div>
    </header>
    <div id="wrapper">
      <div id="container">
        <div id="main-container">
          <slot />
        </div>
        <div id="aside-container">
          <slot name="aside">
            <input class="search-icon" name="icon" type="checkbox" placeholder="Search" />
            <form class="search-form" action={searchAction} method="get">
              {GOOGLE_SEARCH_SITE ? <input type="hidden" name="as_sitesearch" value={GOOGLE_SEARCH_SITE} /> : null}
              <input type="text" name="q" placeholder="Search" />
            </form>
            <div class="copyright-wrap">
              Powered by
              <a
                href="https://github.com/ccbikai/BroadcastChannel"
                title="BroadcastChannel"
                target="_blank"
                rel="noopener"
              >
                BroadcastChannel
              </a> &
              <a href="https://github.com/Planetable/SiteTemplateSepia" title="Sepia" target="_blank" rel="noopener">
                Sepia
              </a>
            </div>
          </slot>
        </div>
      </div>
    </div>
    <a href="#wrapper" id="back-to-top" aria-label="Back to top">
      <img {...backToTopIcon} alt="Back to Top" />
    </a>
    <Fragment set:html={FOOTER_INJECT} />
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.querySelector('[data-nav-toggle]')
        const panel = document.querySelector('[data-mobile-nav]')
        const icon = toggle?.querySelector('.nav-toggle-icon')

        const setNavState = (nextState) => {
          toggle?.setAttribute('aria-expanded', String(nextState))
          if (panel) {
            panel.hidden = !nextState
          }
          if (icon) {
            icon.classList.toggle('open', nextState)
          }
        }

        toggle?.addEventListener('click', () => {
          const isOpen = toggle.getAttribute('aria-expanded') === 'true'
          setNavState(!isOpen)
        })

        panel?.querySelectorAll('a')?.forEach((link) => {
          link.addEventListener('click', () => setNavState(false))
        })
      })
    </script>
  </body>
</html>
